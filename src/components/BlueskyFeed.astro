---
import { BLUESKY_HANDLE } from "../consts";

interface BlueskyImage {
  thumb: string;
  fullsize: string;
  alt: string;
}

interface BlueskyPost {
  uri: string;
  cid: string;
  author: {
    handle: string;
    displayName: string;
    avatar?: string;
  };
  record: {
    text: string;
    createdAt: string;
    reply?: object;
  };
  embed?: {
    $type: string;
    images?: BlueskyImage[];
    playlist?: string;
    thumbnail?: string;
    alt?: string;
    external?: {
      uri: string;
      title: string;
      description: string;
      thumb?: string;
    };
  };
}

let posts: BlueskyPost[] = [];
let error = null;

try {
  const response = await fetch(
    `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${BLUESKY_HANDLE}&limit=10`,
  );

  if (response.ok) {
    const data = await response.json();
    posts = data.feed
      .filter((item: any) => !item.post.record.reply)
      .map((item: any) => item.post)
      .slice(0, 3);
  } else {
    error = "Failed to load posts";
  }
} catch (e) {
  error = "Failed to connect to Bluesky";
  console.error("Bluesky feed error:", e);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days === 0) return "Today";
  if (days === 1) return "Yesterday";
  if (days < 7) return `${days}d ago`;

  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

function getPostUrl(uri: string) {
  const parts = uri.replace("at://", "").split("/");
  const handle = parts[0];
  const postId = parts[parts.length - 1];
  return `https://bsky.app/profile/${handle}/post/${postId}`;
}

function normalizeUrl(urlOrDomain: string) {
  if (/^https?:\/\//i.test(urlOrDomain)) return urlOrDomain;
  return `https://${urlOrDomain}`;
}

function extractFirstUrlLike(text: string) {
  const urlRegex =
    /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/[^\s<>()]+|(?:m\.)?(?:music\.)?youtube\.com\/[^\s<>()]+)/gi;

  for (const match of text.matchAll(urlRegex)) {
    const raw = match[0];
    const cleaned = raw.replace(/[)\].,!?]+$/, "");
    return normalizeUrl(cleaned);
  }

  return null;
}

function getYouTubeIdFromUrl(urlOrDomain: string) {
  try {
    const url = new URL(normalizeUrl(urlOrDomain));
    const hostname = url.hostname.replace(/^www\./, "");

    if (hostname === "youtu.be") {
      const id = url.pathname.split("/").filter(Boolean)[0];
      return id && id.length === 11 ? id : null;
    }

    if (hostname.endsWith("youtube.com")) {
      if (url.pathname === "/watch") {
        const id = url.searchParams.get("v");
        return id && id.length === 11 ? id : null;
      }

      const shortsMatch = url.pathname.match(/^\/shorts\/([A-Za-z0-9_-]{11})/);
      if (shortsMatch) return shortsMatch[1];

      const embedMatch = url.pathname.match(/^\/embed\/([A-Za-z0-9_-]{11})/);
      if (embedMatch) return embedMatch[1];
    }
  } catch {
    // ignore malformed URLs
  }

  return null;
}

function isExternalEmbed(embed: BlueskyPost["embed"]) {
  return Boolean(
    embed?.external && embed.$type?.startsWith("app.bsky.embed.external"),
  );
}

function getYouTubeIdFromPost(post: BlueskyPost) {
  if (isExternalEmbed(post.embed) && post.embed?.external?.uri) {
    const idFromEmbed = getYouTubeIdFromUrl(post.embed.external.uri);
    if (idFromEmbed) return idFromEmbed;
  }

  const firstUrl = extractFirstUrlLike(post.record.text);
  if (!firstUrl) return null;
  return getYouTubeIdFromUrl(firstUrl);
}

function isYouTubeUrl(urlOrDomain: string) {
  try {
    const url = new URL(normalizeUrl(urlOrDomain));
    const hostname = url.hostname.replace(/^www\./, "");
    return hostname === "youtu.be" || hostname.endsWith("youtube.com");
  } catch {
    return false;
  }
}

type TextToken =
  | { kind: "text"; value: string }
  | { kind: "link"; value: string; href: string };

function tokenizeTextWithYouTubeLinks(text: string): TextToken[] {
  const urlRegex =
    /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/[^\s<>()]+|(?:m\.)?(?:music\.)?youtube\.com\/[^\s<>()]+)/gi;

  const tokens: TextToken[] = [];
  let lastIndex = 0;

  for (const match of text.matchAll(urlRegex)) {
    const raw = match[0];
    const start = match.index ?? 0;

    if (start > lastIndex) {
      tokens.push({ kind: "text", value: text.slice(lastIndex, start) });
    }

    const cleaned = raw.replace(/[)\].,!?]+$/, "");
    const trailing = raw.slice(cleaned.length);

    tokens.push({ kind: "link", value: cleaned, href: normalizeUrl(cleaned) });
    if (trailing) tokens.push({ kind: "text", value: trailing });

    lastIndex = start + raw.length;
  }

  if (lastIndex < text.length) {
    tokens.push({ kind: "text", value: text.slice(lastIndex) });
  }

  return tokens;
}
---

<section class="bluesky-section">
  <div class="section-head">
    <div class="num-block num-pink">
      <span class="num">03</span>
    </div>
    <div class="head-text">
      <span class="head-jp">最新情報</span>
      <h2 class="head-title">Latest Updates</h2>
    </div>
    <div class="head-rule"></div>
    <a
      href={`https://bsky.app/profile/${BLUESKY_HANDLE}`}
      target="_blank"
      rel="noopener noreferrer"
      class="bluesky-link"
    >
      View on Bluesky →
    </a>
  </div>

  {
    error ? (
      <div class="rounded-lg border border-[#ff6b6b] bg-[#ff6b6b]/10 p-8 text-center text-[#ff6b6b]">
        {error}
      </div>
    ) : (
      <div class="bluesky-grid grid grid-cols-[repeat(auto-fit,minmax(min(350px,100%),1fr))] gap-8">
        {posts.map((post) => (
          <article class="border-cyber-pink hover:border-cyber-cyan box-border rounded-lg border bg-black/50 p-6 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-[0_0_20px_rgba(0,229,195,0.2)]">
            <div class="mb-4 flex items-start justify-between">
              <div class="flex items-center gap-3">
                {post.author.avatar && (
                  <img
                    src={post.author.avatar}
                    alt={post.author.displayName}
                    class="border-cyber-pink h-12 w-12 rounded-full border-2"
                  />
                )}
                <div class="flex flex-col">
                  <span class="text-cyber-cyan font-semibold">
                    {post.author.displayName}
                  </span>
                  <span class="text-cyber-gray text-sm">
                    @{post.author.handle}
                  </span>
                </div>
              </div>
              <time class="text-cyber-gray text-sm">
                {formatDate(post.record.createdAt)}
              </time>
            </div>

            <p class="text-cyber-gray-dark my-4 leading-relaxed whitespace-pre-line">
              {tokenizeTextWithYouTubeLinks(post.record.text).map((token) =>
                token.kind === "text" ? (
                  token.value
                ) : (
                  <a
                    href={token.href}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-cyber-cyan break-words no-underline hover:text-white"
                  >
                    {token.value}
                  </a>
                ),
              )}
            </p>

            {(() => {
              const youTubeId = getYouTubeIdFromPost(post);

              if (!youTubeId) return null;

              return (
                <div class="youtube-embed my-4 overflow-hidden rounded-lg">
                  <iframe
                    src={`https://www.youtube-nocookie.com/embed/${youTubeId}`}
                    title="YouTube video player"
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                    referrerpolicy="strict-origin-when-cross-origin"
                    class="border-cyber-pink hover:border-cyber-cyan block w-full border bg-black transition-all duration-300 hover:shadow-[0_0_15px_rgba(0,229,195,0.3)]"
                  />
                </div>
              );
            })()}

            {post.embed?.images && post.embed.images.length > 0 && (
              <div
                class={
                  post.embed.images.length === 1
                    ? "my-4 max-w-full overflow-hidden rounded-lg"
                    : "my-4 grid grid-cols-2 gap-2 overflow-hidden rounded-lg"
                }
              >
                {post.embed.images.map((image) => (
                  <a
                    href={getPostUrl(post.uri)}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <img
                      src={image.fullsize}
                      alt={image.alt || "Post image"}
                      loading="lazy"
                      class={
                        post.embed?.images?.length === 1
                          ? "border-cyber-pink hover:border-cyber-cyan block h-auto w-full rounded-lg border transition-all duration-300 hover:shadow-[0_0_15px_rgba(0,229,195,0.3)]"
                          : "border-cyber-pink hover:border-cyber-cyan h-[200px] w-full rounded-lg border object-cover transition-all duration-300 hover:shadow-[0_0_15px_rgba(0,229,195,0.3)]"
                      }
                    />
                  </a>
                ))}
              </div>
            )}

            {post.embed?.$type === "app.bsky.embed.video#view" &&
              post.embed.playlist && (
                <div class="my-4 overflow-hidden rounded-lg">
                  <video
                    controls
                    poster={post.embed.thumbnail}
                    preload="metadata"
                    class="border-cyber-pink hover:border-cyber-cyan block h-auto w-full rounded-lg border bg-black transition-all duration-300 hover:shadow-[0_0_15px_rgba(0,229,195,0.3)]"
                  >
                    <source
                      src={post.embed.playlist}
                      type="application/x-mpegURL"
                    />
                    Your browser does not support the video tag.
                  </video>
                </div>
              )}

            {isExternalEmbed(post.embed) &&
              post.embed?.external &&
              !isYouTubeUrl(post.embed.external.uri) && (
                <a
                  href={post.embed.external.uri}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="border-cyber-pink hover:border-cyber-cyan hover:bg-cyber-cyan/5 my-4 flex gap-4 rounded-lg border bg-black/30 p-4 no-underline transition-all duration-300"
                >
                  {post.embed.external.thumb && (
                    <img
                      src={post.embed.external.thumb}
                      alt={post.embed.external.title}
                      class="border-cyber-pink h-[120px] w-[120px] flex-shrink-0 rounded border object-cover"
                    />
                  )}
                  <div class="flex flex-1 flex-col gap-2">
                    <div class="text-cyber-cyan text-base font-semibold">
                      {post.embed.external.title}
                    </div>
                    {post.embed.external.description && (
                      <div class="text-cyber-gray line-clamp-2 text-sm leading-snug">
                        {post.embed.external.description}
                      </div>
                    )}
                  </div>
                </a>
              )}

            <a
              href={getPostUrl(post.uri)}
              target="_blank"
              rel="noopener noreferrer"
              class="text-cyber-cyan mt-2 inline-block text-sm font-medium"
            >
              View post →
            </a>
          </article>
        ))}
      </div>
    )
  }
</section>

<style>
  .bluesky-section {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 3rem;
    border-bottom: 1px solid #12121e;
  }

  .section-head {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    margin-bottom: 3rem;
  }

  .num-block {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid;
    flex-shrink: 0;
  }

  .num-pink {
    border-color: #e8157a;
  }

  .num {
    font-family: "Bebas Neue", sans-serif;
    font-size: 1.8rem;
    color: #fff;
    line-height: 1;
  }

  .head-text {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .head-jp {
    font-family: "Noto Sans JP", sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    color: #00e5c3;
    letter-spacing: 0.2em;
  }

  .head-title {
    font-family: "Bebas Neue", sans-serif;
    font-size: 2.2rem;
    letter-spacing: 0.08em;
    color: #fff;
    margin: 0;
    text-shadow: none;
    text-transform: uppercase;
  }

  .head-rule {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, #1a1a28, transparent);
  }

  .bluesky-link {
    margin-left: auto;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.78rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    text-decoration: none;
    color: #e8157a;
    border: 1px solid #e8157a;
    padding: 0.4rem 1rem;
    transition: all 0.15s ease;
    flex-shrink: 0;
  }

  .bluesky-link:hover {
    background: #e8157a;
    color: #fff;
  }

  .youtube-embed iframe {
    aspect-ratio: 16 / 9;
    height: auto;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 1024px) {
    .bluesky-grid {
      grid-template-columns: 1fr !important;
    }
  }

  @media (max-width: 720px) {
    .bluesky-section {
      padding: 2.5rem 1.25rem;
    }

    .section-head {
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .num-block {
      width: 45px;
      height: 45px;
    }

    .num {
      font-size: 1.4rem;
    }

    .head-title {
      font-size: 1.6rem;
    }

    article {
      padding: 1rem !important;
    }

    .w-12.h-12 {
      width: 40px !important;
      height: 40px !important;
    }

    .grid-cols-2 {
      grid-template-columns: 1fr !important;
    }

    .h-\[200px\] {
      height: 250px !important;
    }

    .flex.gap-4 {
      flex-direction: column !important;
    }

    .w-\[120px\].h-\[120px\] {
      width: 100% !important;
      height: 200px !important;
    }
  }
</style>
