---
import { BLUESKY_HANDLE } from '../consts';

interface BlueskyImage {
  thumb: string;
  fullsize: string;
  alt: string;
}

interface BlueskyPost {
  uri: string;
  cid: string;
  author: {
    handle: string;
    displayName: string;
    avatar?: string;
  };
  record: {
    text: string;
    createdAt: string;
  };
  embed?: {
    $type: string;
    images?: BlueskyImage[];
    playlist?: string;
    thumbnail?: string;
    alt?: string;
    external?: {
      uri: string;
      title: string;
      description: string;
      thumb?: string;
    };
  };
}

let posts: BlueskyPost[] = [];
let error = null;

try {
  const response = await fetch(
    `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${BLUESKY_HANDLE}&limit=3`
  );

  if (response.ok) {
    const data = await response.json();
    posts = data.feed.map((item: any) => item.post);
  } else {
    error = 'Failed to load posts';
  }
} catch (e) {
  error = 'Failed to connect to Bluesky';
  console.error('Bluesky feed error:', e);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days}d ago`;

  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function getPostUrl(uri: string) {
  const parts = uri.replace('at://', '').split('/');
  const handle = parts[0];
  const postId = parts[parts.length - 1];
  return `https://bsky.app/profile/${handle}/post/${postId}`;
}
---

<section class="bluesky-feed">
  <div class="feed-header">
    <h2>Latest Updates via Bluesky</h2>
    <a href={`https://bsky.app/profile/${BLUESKY_HANDLE}`} target="_blank" rel="noopener noreferrer" class="view-all">
      View on Bluesky →
    </a>
  </div>

  {error ? (
    <div class="error-message">
      {error}
    </div>
  ) : (
    <div class="posts">
      {posts.map((post) => (
        <article class="post">
          <div class="post-header">
            <div class="author">
              {post.author.avatar && (
                <img src={post.author.avatar} alt={post.author.displayName} class="avatar" />
              )}
              <div class="author-info">
                <span class="display-name">{post.author.displayName}</span>
                <span class="handle">@{post.author.handle}</span>
              </div>
            </div>
            <time class="post-date">{formatDate(post.record.createdAt)}</time>
          </div>

          <p class="post-text">{post.record.text}</p>

          {post.embed?.images && post.embed.images.length > 0 && (
            <div class={`post-images ${post.embed.images.length === 1 ? 'single' : 'grid'}`}>
              {post.embed.images.map((image) => (
                <a href={getPostUrl(post.uri)} target="_blank" rel="noopener noreferrer">
                  <img
                    src={image.fullsize}
                    alt={image.alt || 'Post image'}
                    loading="lazy"
                  />
                </a>
              ))}
            </div>
          )}

          {post.embed?.$type === 'app.bsky.embed.video#view' && post.embed.playlist && (
            <div class="post-video">
              <video
                controls
                poster={post.embed.thumbnail}
                preload="metadata"
              >
                <source src={post.embed.playlist} type="application/x-mpegURL" />
                Your browser does not support the video tag.
              </video>
            </div>
          )}

          {post.embed?.$type === 'app.bsky.embed.external' && post.embed.external && (
            <a href={post.embed.external.uri} target="_blank" rel="noopener noreferrer" class="external-link">
              {post.embed.external.thumb && (
                <img src={post.embed.external.thumb} alt={post.embed.external.title} class="external-thumb" />
              )}
              <div class="external-info">
                <div class="external-title">{post.embed.external.title}</div>
                {post.embed.external.description && (
                  <div class="external-description">{post.embed.external.description}</div>
                )}
              </div>
            </a>
          )}

          <a href={getPostUrl(post.uri)} target="_blank" rel="noopener noreferrer" class="post-link">
            View post →
          </a>
        </article>
      ))}
    </div>
  )}
</section>

<style>
  .bluesky-feed {
    margin: 3rem 0;
  }

  .feed-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--purple);
    padding-bottom: 1rem;
  }

  .feed-header h2 {
    margin: 0;
    font-size: 2rem;
  }

  .view-all {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border: 1px solid var(--cyan);
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  .view-all:hover {
    background-color: rgba(177, 255, 236, 0.1);
    box-shadow: var(--glow-cyan);
  }

  .error-message {
    padding: 2rem;
    text-align: center;
    color: #ff6b6b;
    border: 1px solid #ff6b6b;
    border-radius: 8px;
    background-color: rgba(255, 107, 107, 0.1);
  }

  .posts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(350px, 100%), 1fr));
    gap: 2rem;
  }

  .post {
    padding: 1.5rem;
    background-color: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--purple);
    border-radius: 8px;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  .post:hover {
    border-color: var(--cyan);
    box-shadow: 0 0 20px rgba(177, 255, 236, 0.2);
    transform: translateY(-2px);
  }

  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid var(--purple);
  }

  .author-info {
    display: flex;
    flex-direction: column;
  }

  .display-name {
    font-weight: 600;
    color: var(--cyan);
  }

  .handle {
    font-size: 0.85rem;
    color: rgb(var(--gray));
  }

  .post-date {
    font-size: 0.85rem;
    color: rgb(var(--gray));
  }

  .post-text {
    margin: 1rem 0;
    line-height: 1.6;
    color: rgb(var(--gray-dark));
    white-space: pre-wrap;
  }

  .post-link {
    display: inline-block;
    font-size: 0.9rem;
    margin-top: 0.5rem;
    color: var(--accent);
    font-weight: 500;
  }

  .post-images {
    margin: 1rem 0;
    border-radius: 8px;
    overflow: hidden;
  }

  .post-images.single {
    max-width: 100%;
  }

  .post-images.single img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
    border: 1px solid var(--purple);
    transition: all 0.3s ease;
  }

  .post-images.single a:hover img {
    border-color: var(--cyan);
    box-shadow: 0 0 15px rgba(177, 255, 236, 0.3);
  }

  .post-images.grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .post-images.grid img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--purple);
    transition: all 0.3s ease;
  }

  .post-images.grid a:hover img {
    border-color: var(--cyan);
    box-shadow: 0 0 15px rgba(177, 255, 236, 0.3);
  }

  .post-video {
    margin: 1rem 0;
    border-radius: 8px;
    overflow: hidden;
  }

  .post-video video {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
    border: 1px solid var(--purple);
    background-color: #000;
    transition: all 0.3s ease;
  }

  .post-video video:hover {
    border-color: var(--cyan);
    box-shadow: 0 0 15px rgba(177, 255, 236, 0.3);
  }

  .external-link {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    margin: 1rem 0;
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--purple);
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .external-link:hover {
    border-color: var(--cyan);
    background-color: rgba(177, 255, 236, 0.05);
  }

  .external-thumb {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid var(--purple);
    flex-shrink: 0;
  }

  .external-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .external-title {
    font-weight: 600;
    color: var(--cyan);
    font-size: 1rem;
  }

  .external-description {
    font-size: 0.9rem;
    color: rgb(var(--gray));
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 1024px) {
    .posts {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 720px) {
    .bluesky-feed {
      margin: 2rem 0;
    }

    .feed-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .post {
      padding: 1rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
    }

    .post-images.grid {
      grid-template-columns: 1fr;
    }

    .post-images.grid img {
      height: 250px;
    }

    .external-link {
      flex-direction: column;
    }

    .external-thumb {
      width: 100%;
      height: 200px;
    }
  }
</style>
